@page "/"
@rendermode InteractiveServer
@attribute [StreamRendering]
@inject IConfiguration Config
@inject IDialogService DialogService

<PageTitle>MudBlazor Chatbot</PageTitle>

<MudAppBar Color="Color.Default" Fixed="true">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="4" Class="d-flex align-center justify-center mud-width-full">
            @if (ollama is not null && !loadingOllama)
            {
                <MudMenu Label="@(models.Any() && !string.IsNullOrWhiteSpace(ollama.SelectedModel) ? ollama.SelectedModel : "Choose a model")" Variant="Variant.Filled" Dense="true" FullWidth="true"
                         EndIcon="@Icons.Material.Filled.KeyboardArrowDown" IconColor="Color.Secondary" @ref="modelMenu">
                    <MudMenuItem @onclick="OpenDownloadModelsAsync" Icon="@Icons.Material.Filled.Download" IconColor="Color.Tertiary">
                        Download Additional Models
                    </MudMenuItem>
                    @foreach (var model in models)
                    {
                        <MudMenuItem @onclick="() => chatbot!.SetSelectedModel(model.Name)">
                            @(model.Name)
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete" Size="Size.Small"
                                           Color="Color.Secondary" Class="float-end" @onclick="() => DeleteModelAsync(model.Name)"/>
                        </MudMenuItem>
                    }
                </MudMenu>
                <MudSpacer />
            }
            else if (loadingOllama)
            {
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true"/>
            }
        </MudItem>
        <MudItem xs="4" Class="d-flex align-center justify-center mud-width-full">
            <MudText Typo="Typo.h5" Class="">MudBlazor Chatbot</MudText>
        </MudItem>
        <MudItem xs="4" Class="d-flex align-center justify-center mud-width-full">
            <MudSpacer />
            <MudIconButton Href="https://github.com/Garrett-Hub/MudBlazorChatbot" Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" Edge="Edge.End"/>
        </MudItem>
    </MudGrid>
</MudAppBar>

@if (ollama is not null && models.Any())
{
    <Chatbot @ref="chatbot" Ollama="ollama" />
}
else if (!loadingOllama)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Style="padding-top: 100px;">
    @if (ollama is null)
    {
        <MudAlert Severity="Severity.Error">Failed to connect to Ollama Api. Please check the configuration, make sure Ollama is running, and try again.</MudAlert>
    }
    else if (!models.Any())
    {
        <MudAlert Severity="Severity.Warning">Connected to Ollama Api, but no models were found. Please download a model to begin chatting.</MudAlert>
    }
    </MudContainer>
}

@code {
    private OllamaApiClient? ollama;
    private IEnumerable<Model> models = new List<Model>();
    private Chatbot? chatbot;
    private MudMenu? modelMenu;

    private bool loadingOllama;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            loadingOllama = true;
            ollama = new OllamaApiClient(Config["OllamaUri"]!);
            await LoadModelsAsync();
        }
        catch
        {
            ollama = null;
        }
        finally
        {
            loadingOllama = false;
            StateHasChanged();
            if (models.Any() && chatbot is not null)
            {
                chatbot.SetSelectedModel(models.First().Name);
            }
        }
    }

    private async Task LoadModelsAsync()
    {
        models = await ollama!.ListLocalModelsAsync();
    }

    private async Task OpenDownloadModelsAsync()
    {
        var parameters = new DialogParameters<DownloadModels> { { x => x.Ollama, ollama } };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DownloadModels>("Download Models", parameters, options);
        await dialog.Result;
        
        loadingOllama = true;
        StateHasChanged();
        await LoadModelsAsync();
        if (models.Any() && string.IsNullOrWhiteSpace(ollama!.SelectedModel))
        {
            chatbot?.SetSelectedModel(models.First().Name);
        }
        loadingOllama = false;
    }

    private async Task DeleteModelAsync(string modelName)
    {
        await modelMenu!.CloseMenuAsync();
        
        var parameters = new DialogParameters<DeleteModel>
        {
            { x => x.Ollama, ollama },
            { x => x.ModelName, modelName }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DeleteModel>("Delete Model", parameters, options);
        await dialog.Result;
        
        loadingOllama = true;
        StateHasChanged();
        await LoadModelsAsync();
        if (models.Any() && ollama!.SelectedModel.Equals(modelName, StringComparison.OrdinalIgnoreCase))
        {
            chatbot?.SetSelectedModel(models.First().Name);
        }
        loadingOllama = false;
    }
}